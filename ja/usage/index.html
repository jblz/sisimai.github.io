---
layout: document
directory: usage
title: Sisimaiでの解析方法
description: Sisimaiの解析方法・オプション・コールバック機能
author: azumakuniyuki
---

<a id = 'tohash' href = '#'></a>
<header id = 'home'>
    <div class = 'main-nav'>
        <div class = 'container'>
            <div class = 'navbar-header'>
                <button type = 'button' class = 'navbar-toggle' data-toggle = 'collapse' data-target = '.navbar-collapse'>
                    <span class = 'sr-only'>Toggle navigation</span>
                    <span class = 'icon-bar'></span>
                    <span class = 'icon-bar'></span>
                    <span class = 'icon-bar'></span>
                </button>
                <a class = 'navbar-brand' href = '/'>
                    <h1>
                        <img class = 'img-responsive' src = '/static/images/logo/sisimai-logotype-w11.png' 
                            width = '144' alt = 'Sisimai: Mail Analyzing Interface'>
                    </h1>
                </a>
            </div>
            <div class = 'collapse navbar-collapse'>
                <ul class = 'nav navbar-nav navbar-right'>
                    <li class = 'scroll'><a href = '/ja'><i class = 'fa fa-home'></i></a></li> 
                    <li class = 'scroll active'><a href = '#index'><i class = 'fa fa-arrow-circle-up'></i></a></li> 
                    <li class = 'scroll'><a href = '#stdin'>標準入力</a></li>
                    <li class = 'scroll'><a href = '#delivered'>配信成功も</a></li>
                    <li class = 'scroll'><a href = '#callback'>コールバック</a></li>
                    <li class = 'others'><a href = '/ja/docs'>ドキュメント</a></li>
                    <li class = 'others'><a href = '/en/usage'><i class = 'fa fa-language'></i></a></li>
                </ul>
            </div>
        </div>
    </div> <!-- /#main-nav -->
</header> <!-- /#home -->

<section id = 'index'>
    <div class = 'container'>
        <div class = 'heading'>
            <div class = 'row'>
                <div class = 'text-center col-sm-8 col-sm-offset-2'>
                    <img src = '/static/images/logo/sisimai-x01.png' width = '20%'>
                    <h2>シシマイでの解析方法</h2>
                </div>
            </div>
        </div>
        <div class = 'text-center index-table'>
            <div class = 'row'>
                <div class = 'col-sm-3'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-keyboard-o'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>基本的な使い方</h3>
                        <hr>
                        <p class = 'description ja'>
                            メールの解析、構造化されたデータの取得とJSON化など
                            簡単な使い方を紹介します。
                        </p>
                    </div>
                    <a href = '/ja/start/#usage' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-3'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-desktop'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>標準入力から読む</h3>
                        <hr>
                        <p class = 'description ja'>
                            標準入力(STDIN)からバウンスメールのデータを読み込み
                            {{ site.html.ss }}で解析する方法の記述例です。
                        </p>
                    </div>
                    <a href = '#stdin' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-3'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-truck'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>配信成功も含める</h3>
                        <hr>
                        <p class = 'description ja'>
                            配信が成功したメール(配信通知)も解析結果に含める方法を
                            紹介します。
                        </p>
                    </div>
                    <a href = '#delivered' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-3'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-cog'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>コールバック</h3>
                        <hr>
                        <p class = 'description ja'>
                            コールバック機能を使うと、Sisimaiが解析する前のデータ
                            に対して、独自の処理を行うことができます。
                        </p>
                    </div>
                    <a href = '#callback' class = 'btn btn-continue'>Read</a>
                </div>
            </div>
        </div>
    </div>
</section> <!-- /#index -->

<section id = 'stdin' class = 'parallax'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-desktop'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>標準入力から読む</h2>
                <hr>
                <p class = 'description ja'>
                    {{ site.html.ss }}(シシマイ)の<kbd>make()</kbd>や<kbd>dump()</kbd>メソッドは、
                    引数にファイル名を指定する以外に、<kbd>STDIN</kbd>を指定することによって、
                    標準入力(STDIN)からバウンスメールのデータを読み込むことができます。
                    この機能は初期の{{ site.html.ss }}から実装されていましたが、バグがあったため、
                    読み込みができない場合がありました。このバグはSisimai 4.18.1
                    <a href = 'https://github.com/sisimai/p5-Sisimai/issues/194' target = 'new'>
                    (Perl版)
                    </a>
                    <a href = 'https://github.com/sisimai/rb-Sisimai/issues/61' target = 'new'>
                    (Ruby版)
                    </a>
                    にて修正済みです。
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>STDINファイルハンドル</h4>
                <p class = 'description ja'>
                    Sisimaiクラスの<kbd>dump()</kbd>と<kbd>make()</kbd>メソッドは、
                    第一引数にファイルハンドル<kbd>STDIN</kbd>を指定すると、
                    標準入力からバウンスメールのデータを読み込み、解析結果を返します。
                </p>

                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | perl -MSisimai -lE 'print Sisimai->dump(STDIN)' | jq</kbd>
[
  {
    "listid": "",
    "smtpagent": "Sendmail",
    ...
                </pre>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | perl -MSisimai -lE 'print $_->recipient->address for @{ Sisimai->make(STDIN) }'</kbd>
kijitora@example.jp
sironeko@example.org
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>STDINオブジェクト</h4>
                <p class = 'description ja'>
                    Ruby版{{ site.html.ss }}も同様に、Sisimaiクラスの<kbd>dump()</kbd>と<kbd>make()</kbd>メソッドの
                    第一引数に<kbd>STDIN</kbd>オブジェクトを指定すると、
                    標準入力からバウンスメールのデータを読み込み、解析結果を返します。
                </p>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | ruby -Ilib -rsisimai -e 'puts Sisimai.dump(STDIN)' | jq</kbd>
[
  {
    "catch": "",
    "token": "d295b517a3ad6f8748031e1068e07ebd089c0277",
    ...
                </pre>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | ruby -rsisimai -e 'p Sisimai.make(STDIN)'</kbd>
[#&lt;Sisimai::Data:0x007fa1b0993050 @addresser=#&lt;Sisimai::Address:0x007fa1b0990e40 @user="kijitora", ...
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
            </div>
        </div>

    </div>
</section> <!-- /#stdin -->

<section id = 'delivered'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-truck'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>配信成功も解析結果に含める</h2>
                <p class = 'description ja'>
                    Sisimaiの<kbd>make()</kbd>と<kbd>dump()</kbd>は第二引数に<kbd>delivered</kbd>
                    を指定することによって、配信が成功した事を通知するメールも解析結果に含めることができます。
                </p>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>email</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>配信成功のサンプルメール</h3>
                <p class = 'description ja'>
                    <img class = 'lhs' src = '/static/images/icon/message-3.png'>
                    配送が成功したメールは
                    <a href = 'https://github.com/sisimai/set-of-emails' target = 'new'>github.com/sisimai/set-of-emails</a>
                    リポジトリの
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/rfc3464-28.eml' target = 'new'>
                        rfc3464-28.eml
                    </a>
                    がサンプルとして用意してあります。
                    ここでは、このメールを解析するサンプルコードを紹介します。
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>delivered =&gt; 1</h4>
                <p class = 'description ja'>
                    <kbd>make()</kbd>と<kbd>dump()</kbd>の第二引数に<kbd>delivered =&gt; 1</kbd>を指定すると、
                    配信に成功したメール(配信通知)も解析結果に含まれるようになります。<kbd>delivered</kbd>
                    に偽となる値(0,undef,'')を指定した場合は、解析結果は生成されません。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
my $f = './set-of-emails/maildir/bsd/rfc3464-28.eml';
my $v = Sisimai->make($f, <strong>'delivered' => 1</strong>);
for my $e ( @$v ) {
    print $e->action;           # deliverable
    print $e->deliverystatus;   # 2.1.5
    print $e->reason;           # delivered
    print $e->diagnosticcode;   # 250 2.1.5 Ok
    print $e->softbounce;       # -1
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>delivered: true</h4>
                <p class = 'description ja'>
                    Perl版と同様に、Ruby版{{ site.html.ss }}でも<kbd>make()</kbd>と<kbd>dump()</kbd>の第二引数に
                    <kbd>delivered: true</kbd>を指定すると、配信に成功したメール(配信通知)も
                    解析結果に含まれるようになります。<kbd>delivered</kbd>
                    に偽となる値(nil,false)を指定した場合は、解析結果は生成されません。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
f = './set-of-emails/maildir/bsd/rfc3464-28.eml'
v = Sisimai.make(f, <strong>delivered: true</strong>)
v.each do |e|
  puts e.action         # deliverable
  puts e.deliverystatus # 2.1.5
  puts e.reason         # delivered
  puts e.diagnosticcode # 250 2.1.5 Ok
  puts e.softbounce     # -1
end
                </pre>
            </div>
        </div>
    </div>
</section> <!-- /#delivered -->

<section id = 'callback' class = 'parallax'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-cog'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2>コールバック機能</h2>
                <p class = 'description ja'>
                    {{ site.html.ss }} 4.19.0から実装されたコールバック機能を使用すると、
                    <kbd>Sisimai::Data</kbd>または<kbd>Sisimai::Message</kbd>の<kbd>catch()</kbd>
                    メソッドを通して、バウンスメールを独自に処理した結果を取得することができます。
                    この機能は{{ site.html.ss }}が解析結果に含めない元メッセージ全体や
                    元メッセージの特定のヘッダの値(例えば配信IDなど)を取り出したりするのに便利です。
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>email</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>qmail-06.eml</h3>
                <p class = 'description ja'>
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/qmail-06.eml' target = 'new'>
                        qmail-06.eml
                    </a>内、元メッセージの<kbd>X-Mailer: Apple Mail (2.396)</kbd>の値を、
                    コールバックで実行するコードで取得するサンプルコードで説明します。
                </p>
                <pre class = 'prettyprint'>...
Subject: Nyaaan
Date: Wed, 31 Mar 2010 22:59:43 +0900
<strong>X-Mailer: Apple Mail (2.936)</strong>
Nyaan
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>argv</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>呼び出されるメソッドの引数</h3>
                <p class = 'description ja'>
                    Perlのフックメソッド(サブルーチン)には<strong>ハッシュリファレンス1つ</strong>、
                    Rubyのフックメソッドには<strong>Hashオブジェクト1つ</strong>
                    が引数として渡されます。引数の構造は以下のようになっています。
                </p>
                <div class = 'table-responsive'>
                    <table class = 'table table-hover table-bordered'>
                        <thead>
                            <tr>
                                <th>キー名</th>
                                <th>データ型</th>
                                <th>説明</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class = 'ltext'>headers</td>
                                <td>Hash</td>
                                <td>バウンスメールのヘッダ部分(ハッシュ化済み)</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>message</td>
                                <td>String</td>
                                <td>バウンスメールのメール本文(改行・元メッセージを含む)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p class = 'description ja'>
                    フックメソッドには一つの引数が以下のように渡されます。
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/qmail-06.eml' target = 'new'>
                        qmail-06.eml
                    </a>のヘッダ部分(ハッシュ化済み)とメッセージ部分(文字列)を構造化したものです。
                    <kbd>undef</kbd>になっている部分は、Rubyでは<kbd>nil</kbd>と読み替えてください。
                </p>

                <pre class = 'prettyprint'>{
    <strong>'headers'</strong> => {
        'from' => 'MAILER-DAEMON@example.co.jp',
        'return-path' => undef,
        'subject' => 'failure notice',
        'to' => 'shironeko@example.co.jp',
        'x-mailer' => undef,
        'content-type' => '',
        'received' => [
            'from 192.0.2.68 (HELO smtp05.relay-4.example.co.jp) (192.0.2.68) by mx317.relay-9.example.co.jp with SMTP; Thu, 01 Apr 2010 23:59:45 +0900',
            '(qmail 10000 invoked for bounce); 1 Apr 2010 14:59:45 -0000'
        ],
        'reply-to' => undef,
        'message-id' => undef,
        'content-transfer-encoding' => undef,
        'date' => '1 Apr 2010 14:59:45 -0000'
    },
    <strong>'message'</strong> => 'Hi. This is the qmail-send program at example.co.jp.
I\'m afraid I wasn\'t able to deliver your message to the following addresses.
This is a permanent error; I\'ve given up. Sorry it didn\'t work out.
...
Content-Type: text/plain; charset=US-ASCII; format=flowed
Content-Transfer-Encoding: 7bit
Mime-Version: 1.0 (Apple Message framework v936)
Subject: Nyaaan
Date: Wed, 31 Mar 2010 22:59:43 +0900
X-Mailer: Apple Mail (2.936)

Nyaan
',
    
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai-&gt;make($f, 'hook' => $x)</h4>
                <p class = 'description ja'>
                    Sisimaiクラスの<kbd>make()</kbd>と<kbd>dump()</kbd>メソッドに、
                    実行したい処理内容を書いたサブルーチンのコードリファレンスを第二引数
                    <kbd>hook</kbd>として渡すことができます。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
my $f = './set-of-emails/maildir/bsd/sendmail-24.eml';
my $x = sub {
    my $argv = shift;
    my $data = { 'x-mailer' => '' };

    if( $argv->{'message'} =~ m/^X-Mailer:\s*(.+)$/m ) {
        $data->{'x-mailer'} = $1;
    }
    return $data;
};
my $j = Sisimai-&gt;dump($f, <strong>'hook' => $x</strong>); # JSON文字列を得る
my $v = Sisimai-&gt;make($f, <strong>'hook' => $x</strong>);
print $v->[0]->{<strong>'catch'</strong>}->{'x-mailer'};     # Apple Mail (2.936)
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai.make(f, hook: x)</h4>
                <p class = 'description ja'>
                    Sisimaiクラスの<kbd>make()</kbd>と<kbd>dump()</kbd>メソッドに、
                    実行したい処理内容を書いたProcオブジェクトを
                    <kbd>hook:</kbd>として渡すことができます。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
f = './set-of-emails/maildir/bsd/sendmail-24.eml'
x = lambda do |argv|
  data = { 'x-mailer' => '' }
  if cv = argv['message'].match(/^X-Mailer:\s*(.+)$/)
    data['x-mailer'] = cv[1]
  end
  return data
end

j = Sisimai.dump(f, <strong>hook: x</strong>)    # JSON文字列を得る
v = Sisimai.make(f, <strong>hook: x</strong>)
puts v[0][<strong>'catch'</strong>]['x-mailer']  # Apple Mail (2.936)
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>JSON</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>dump()で出力したJSON</h3>
                <p class = 'description ja'>
                    Sisimaiの<kbd>dump()</kbd>メソッドにフックメソッドを渡して得たJSON文字列は
                    次のような内容になります。
                </p>
                <pre class = 'prettyprint'>[
  {
    "timestamp": 1270043983,
    "smtpcommand": "RCPT",
    "subject": "Nyaaan",
    "recipient": "kijitora@example.jp",
    "destination": "example.jp",
    "senderdomain": "example.co.jp",
    "token": "bb2a5dfb6161f396300b24acd9bf637c1c45a58a",
    "smtpagent": "qmail",
    "replycode": "450",
    "softbounce": 1,
    <strong>"catch": {
      "x-mailer": "Apple Mail (2.936)"
    },</strong>
    "rhost": "192.0.2.135",
    "timezoneoffset": "+0900",
    "addresser": "shironeko@example.co.jp",
    "diagnostictype": "SMTP",
    "action": "failed",
    "listid": "",
    "feedbacktype": "",
    "diagnosticcode": "192.0.2.135 does not like recipient. Remote host said: 450 4.2.2 <kijitora@example.jp>... Mailbox Full Giving up on 192.0.2.135. I'm not going to try again; this message has been in the queue too long.",
    "reason": "mailboxfull",
    "deliverystatus": "4.2.2",
    "alias": "",
    "lhost": "",
    "messageid": "57D03121-12F7-4801-B30F-9E44B15E56DC@example.co.jp"
  }
]
                </pre>

            </div>
        </div>

    </div>
</section> <!-- #callback -->

